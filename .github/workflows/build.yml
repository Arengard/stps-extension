name: Build Extension

on:
  push:
    branches: [ master, main, develop, dev ]
  pull_request:
    branches: [ master, main, develop, dev ]

jobs:
  linux:
    name: Linux
    runs-on: ubuntu-latest
    env:
      GEN: ninja
      MAKEFLAGS: -j2

    steps:
      - name: Install packages
        run: |
          sudo apt-get update -y -qq
          sudo apt-get install -y -qq cmake ninja-build make gcc g++ git curl zip unzip tar pkg-config

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Fix Git ownership
        run: |
          git config --global --add safe.directory /home/runner/work/stps-extension/stps-extension
          git config --global --add safe.directory '*'

      - name: Setup submodules
        run: |
          # Check if .gitmodules exists
          if [ -f ".gitmodules" ]; then
            git submodule sync
            git submodule update --init --recursive
          else
            echo "Creating .gitmodules file"
            cat > .gitmodules << 'EOF'
          [submodule "duckdb"]
          	path = duckdb
          	url = https://github.com/duckdb/duckdb.git
          [submodule "extension-ci-tools"]
          	path = extension-ci-tools
          	url = https://github.com/duckdb/extension-ci-tools.git
          EOF
            git submodule sync
            git submodule update --init --recursive
          fi

      - name: Create swap space
        run: |
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          echo "Swap created:"
          sudo swapon --show

      - name: Build extension
        run: |
          echo "Starting Linux build process..."
          make debug

      - name: Debug build output
        run: |
          echo "=== Extension files search ==="
          find build -name "*.duckdb_extension" -type f || echo "No .duckdb_extension files found"
          echo ""
          echo "=== Build directory structure ==="
          find build -type f -name "*extension*" || echo "No extension files found"

      - name: Test extension
        run: |
          # Find the extension file
          EXTENSION_FILE=$(find build -name "*.duckdb_extension" -type f | head -1)
          
          if [ -z "$EXTENSION_FILE" ]; then
            echo "❌ No extension file found for testing"
            exit 1
          fi
          
          echo "Found extension file: $EXTENSION_FILE"
          echo "Testing extension loading..."
          
          build/debug/duckdb -c "INSTALL '$EXTENSION_FILE'; LOAD polarsgodmode; SELECT 'Extension loaded successfully';" || {
            echo "❌ Extension failed to load"
            exit 1
          }
          
          echo "✅ Extension loaded and tested successfully!"

  macos:
    name: MacOS
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Setup submodules
        run: |
          # Check if .gitmodules exists
          if [ -f ".gitmodules" ]; then
            git submodule sync
            git submodule update --init --recursive
          else
            echo "Creating .gitmodules file"
            cat > .gitmodules << 'EOF'
          [submodule "duckdb"]
          	path = duckdb
          	url = https://github.com/duckdb/duckdb.git
          [submodule "extension-ci-tools"]
          	path = extension-ci-tools
          	url = https://github.com/duckdb/extension-ci-tools.git
          EOF
            git submodule sync
            git submodule update --init --recursive
          fi

      - name: Build extension
        run: |
          echo "Starting macOS build process..."
          make debug

      - name: Debug build output
        run: |
          echo "=== Extension files search ==="
          find build -name "*.duckdb_extension" -type f || echo "No .duckdb_extension files found"
          echo ""
          echo "=== Build directory structure ==="
          find build -type f -name "*extension*" || echo "No extension files found"

      - name: Test extension
        run: |
          # Find the extension file
          EXTENSION_FILE=$(find build -name "*.duckdb_extension" -type f | head -1)
          
          if [ -z "$EXTENSION_FILE" ]; then
            echo "❌ No extension file found for testing"
            exit 1
          fi
          
          echo "Found extension file: $EXTENSION_FILE"
          echo "Testing extension loading..."
          
          build/debug/duckdb -c "INSTALL '$EXTENSION_FILE'; LOAD polarsgodmode; SELECT 'Extension loaded successfully';" || {
            echo "❌ Extension failed to load"
            exit 1
          }
          
          echo "✅ Extension loaded and tested successfully!"

  windows:
    name: Windows
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Install build dependencies
        run: |
          choco install -y cmake ninja

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v1.0.2

      - name: Setup submodules
        shell: bash
        run: |
          # Check if .gitmodules exists
          if [ -f ".gitmodules" ]; then
            git submodule sync
            git submodule update --init --recursive
          else
            echo "Creating .gitmodules file"
            cat > .gitmodules << 'EOF'
          [submodule "duckdb"]
          	path = duckdb
          	url = https://github.com/duckdb/duckdb.git
          [submodule "extension-ci-tools"]
          	path = extension-ci-tools
          	url = https://github.com/duckdb/extension-ci-tools.git
          EOF
            git submodule sync
            git submodule update --init --recursive
          fi

      - name: Build extension
        shell: bash
        run: |
          echo "Starting Windows build process..."
          make debug

      - name: Debug build output
        shell: bash
        run: |
          echo "=== Extension files search ==="
          find build -name "*.duckdb_extension" -type f 2>/dev/null || echo "No .duckdb_extension files found"
          echo ""
          echo "=== Build directory structure ==="
          find build -type f -name "*extension*" 2>/dev/null || echo "No extension files found"

      - name: Test extension
        shell: bash
        run: |
          # Find the extension file
          EXTENSION_FILE=$(find build -name "*.duckdb_extension" -type f | head -1)
          
          if [ -z "$EXTENSION_FILE" ]; then
            echo "❌ No extension file found for testing"
            exit 1
          fi
          
          echo "Found extension file: $EXTENSION_FILE"
          echo "Testing extension loading..."
          
          # Find DuckDB executable (could be .exe on Windows)
          DUCKDB_EXE=$(find build -name "duckdb*" -executable -type f | head -1)
          if [ -z "$DUCKDB_EXE" ]; then
            DUCKDB_EXE="build/debug/duckdb.exe"
          fi
          
          "$DUCKDB_EXE" -c "INSTALL '$EXTENSION_FILE'; LOAD polarsgodmode; SELECT 'Extension loaded successfully';" || {
            echo "❌ Extension failed to load"
            exit 1
          }
          
          echo "✅ Extension loaded and tested successfully!"
