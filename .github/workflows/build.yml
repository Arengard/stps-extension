name: Build Extension

on:
  push:
    branches: [ master, main, develop, dev ]
  pull_request:
    branches: [ master, main, develop, dev ]

jobs:
  linux:
    name: Linux
    runs-on: ubuntu-latest
    container: ubuntu:22.04
    env:
      GEN: ninja
      MAKEFLAGS: -j$(nproc)

    steps:
      - name: Install packages
        run: |
          apt-get update -y -qq
          apt-get install -y -qq ninja-build make gcc g++ git curl zip unzip tar pkg-config

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Fix Git ownership
        run: |
          git config --global --add safe.directory /__w/stps-extension/stps-extension
          git config --global --add safe.directory '*'

      - name: Setup submodules
        run: |
          # Initialize submodules if they don't exist
          if [ ! -f ".gitmodules" ]; then
            echo "Creating .gitmodules file"
            cat > .gitmodules << 'EOF'
          [submodule "duckdb"]
          	path = duckdb
          	url = https://github.com/duckdb/duckdb.git
          [submodule "extension-ci-tools"]
          	path = extension-ci-tools
          	url = https://github.com/duckdb/extension-ci-tools.git
          EOF
          fi
          
          # Initialize and update submodules
          git submodule add https://github.com/duckdb/duckdb.git duckdb || true
          git submodule add https://github.com/duckdb/extension-ci-tools.git extension-ci-tools || true
          git submodule update --init --recursive

      - name: Build extension
        run: |
          make debug

      - name: Test extension
        run: |
          build/debug/duckdb -c "INSTALL './build/debug/extension/polarsgodmode/polarsgodmode.duckdb_extension'; LOAD polarsgodmode; SELECT 'Extension loaded successfully';"

  macos:
    name: MacOS
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Setup submodules
        run: |
          # Initialize submodules if they don't exist
          if [ ! -f ".gitmodules" ]; then
            echo "Creating .gitmodules file"
            cat > .gitmodules << 'EOF'
          [submodule "duckdb"]
          	path = duckdb
          	url = https://github.com/duckdb/duckdb.git
          [submodule "extension-ci-tools"]
          	path = extension-ci-tools
          	url = https://github.com/duckdb/extension-ci-tools.git
          EOF
          fi
          
          # Initialize and update submodules
          git submodule add https://github.com/duckdb/duckdb.git duckdb || true
          git submodule add https://github.com/duckdb/extension-ci-tools.git extension-ci-tools || true
          git submodule update --init --recursive

      - name: Build extension
        run: |
          make debug

      - name: Test extension
        run: |
          build/debug/duckdb -c "INSTALL './build/debug/extension/polarsgodmode/polarsgodmode.duckdb_extension'; LOAD polarsgodmode; SELECT 'Extension loaded successfully';"
