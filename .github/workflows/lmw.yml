name: Build STPS Extension (Multi-Platform)

on:
  push:
    branches:
      - '**'
  workflow_dispatch:

jobs:
  # ------------------------
  # 1️⃣ macOS build
  # ------------------------
  build-macos:
    name: Build macOS Extension
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Install dependencies
        run: brew install cmake ninja zlib curl

      - name: Build extension
        env:
          BUILD_UNITTESTS: 0
          BUILD_SHELL: 0
        run: make release

      - name: Copy artifact
        run: |
          mkdir -p dist
          # Find the extension in the repository folder (the properly packaged loadable extension)
          EXTENSION_FILE=$(find build/release/repository -name "stps.duckdb_extension" -type f | head -1)
          if [ -z "$EXTENSION_FILE" ]; then
            echo "Extension not found in repository, trying extension folder..."
            EXTENSION_FILE=$(find build/release/extension -name "stps.duckdb_extension" -type f | head -1)
          fi
          if [ -z "$EXTENSION_FILE" ]; then
            echo "Extension file not found!"
            find build -type f -name "*.duckdb_extension" || true
            exit 1
          fi
          echo "Found extension at: $EXTENSION_FILE"
          cp "$EXTENSION_FILE" dist/stps.duckdb_extension

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: stps-macos
          path: dist/stps.duckdb_extension
          retention-days: 90

  # ------------------------
  # 2️⃣ Linux build
  # ------------------------
  build-linux:
    name: Build Linux Extension
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y cmake ninja-build build-essential zlib1g-dev libcurl4-openssl-dev

      - name: Build extension
        env:
          BUILD_UNITTESTS: 0
          BUILD_SHELL: 0
        run: make release

      - name: Copy artifact
        run: |
          mkdir -p dist
          # Find the extension in the repository folder (the properly packaged loadable extension)
          EXTENSION_FILE=$(find build/release/repository -name "stps.duckdb_extension" -type f | head -1)
          if [ -z "$EXTENSION_FILE" ]; then
            echo "Extension not found in repository, trying extension folder..."
            EXTENSION_FILE=$(find build/release/extension -name "stps.duckdb_extension" -type f | head -1)
          fi
          if [ -z "$EXTENSION_FILE" ]; then
            echo "Extension file not found!"
            find build -type f -name "*.duckdb_extension" || true
            exit 1
          fi
          echo "Found extension at: $EXTENSION_FILE"
          cp "$EXTENSION_FILE" dist/stps.duckdb_extension

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: stps-linux-amd64
          path: dist/stps.duckdb_extension
          retention-days: 90

  # ------------------------
  # 3️⃣ Windows build
  # ------------------------
  build-windows:
    name: Build Windows Extension
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Install build dependencies
        run: choco install -y cmake ninja

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11.1
        with:
          vcpkgGitCommitId: 'ce613c41372b23b1f51333815feb3edd87ef8a8b'

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Build extension
        shell: bash
        env:
          BUILD_UNITTESTS: 0
          BUILD_SHELL: 0
          VCPKG_TOOLCHAIN_PATH: ${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake
        run: make release

      - name: Copy artifact
        shell: bash
        run: |
          mkdir -p dist
          # Find the extension in the repository folder (the properly packaged loadable extension)
          EXTENSION_FILE=$(find build/release/repository -name "stps.duckdb_extension" -type f | head -1)
          if [ -z "$EXTENSION_FILE" ]; then
            echo "Extension not found in repository, trying extension folder..."
            EXTENSION_FILE=$(find build/release/extension -name "stps.duckdb_extension" -type f | head -1)
          fi
          if [ -z "$EXTENSION_FILE" ]; then
            echo "Extension file not found!"
            find build -type f -name "*.duckdb_extension" || true
            exit 1
          fi
          echo "Found extension at: $EXTENSION_FILE"
          cp "$EXTENSION_FILE" dist/stps.duckdb_extension

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: stps-windows-amd64
          path: dist/stps.duckdb_extension
          retention-days: 90

  # ------------------------
  # 4️⃣ Test artifacts
  # ------------------------
  test-artifacts:
    name: Test Extension Artifacts
    runs-on: ubuntu-latest
    needs: [build-macos, build-linux, build-windows]
    steps:
      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: stps-linux-amd64
          path: dist/linux

      - name: Install DuckDB
        run: |
          wget https://github.com/duckdb/duckdb/releases/download/v1.4.4/duckdb_cli-linux-amd64.zip
          unzip duckdb_cli-linux-amd64.zip
          chmod +x duckdb

      - name: Run DuckDB load tests
        run: |
          echo "Testing Linux extension..."
          ./duckdb -unsigned -c "INSTALL 'dist/linux/stps.duckdb_extension'; LOAD stps; SELECT 'OK' AS status;"
          echo "Linux extension test passed!"

  # ------------------------
  # 5️⃣ Release creation (on every push)
  # ------------------------
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: test-artifacts
    steps:
      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: stps-macos
          path: dist/macos

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: stps-linux-amd64
          path: dist/linux

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: stps-windows-amd64
          path: dist/windows

      - name: Rename artifacts for release
        run: |
          mv dist/macos/stps.duckdb_extension dist/stps-macos.duckdb_extension
          mv dist/linux/stps.duckdb_extension dist/stps-linux-amd64.duckdb_extension
          mv dist/windows/stps.duckdb_extension dist/stps-windows-amd64.duckdb_extension

      - name: Generate release tag
        id: tag
        run: |
          SHORT_SHA=${GITHUB_SHA::7}
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          echo "tag=build-${TIMESTAMP}-${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "name=Build ${TIMESTAMP} (${SHORT_SHA})" >> $GITHUB_OUTPUT

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: ${{ steps.tag.outputs.name }}
          files: |
            dist/stps-macos.duckdb_extension
            dist/stps-linux-amd64.duckdb_extension
            dist/stps-windows-amd64.duckdb_extension
          draft: false
          prerelease: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
