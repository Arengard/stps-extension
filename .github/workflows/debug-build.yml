name: Debug Build Process

on:
  push:
    branches: [ debug-build ]
  workflow_dispatch:

jobs:
  debug:
    name: Debug Build Process
    runs-on: ubuntu-latest
    container: ubuntu:22.04
    env:
      GEN: ninja
      MAKEFLAGS: -j$(nproc)

    steps:
      - name: Install packages
        run: |
          apt-get update -y -qq
          apt-get install -y -qq ninja-build make gcc g++ git tree

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Fix Git ownership
        run: |
          git config --global --add safe.directory /__w/stps-extension/stps-extension
          git config --global --add safe.directory '*'

      - name: Setup submodules
        run: |
          # Create .gitmodules if it doesn't exist
          if [ ! -f ".gitmodules" ]; then
            cat > .gitmodules << 'EOF'
          [submodule "duckdb"]
          	path = duckdb
          	url = https://github.com/duckdb/duckdb.git
          [submodule "extension-ci-tools"]
          	path = extension-ci-tools
          	url = https://github.com/duckdb/extension-ci-tools.git
          EOF
          fi
          
          # Initialize and update submodules
          git submodule add https://github.com/duckdb/duckdb.git duckdb || true
          git submodule add https://github.com/duckdb/extension-ci-tools.git extension-ci-tools || true
          git submodule update --init --recursive

      - name: Show project structure before build
        run: |
          echo "=== Root directory ==="
          ls -la
          echo ""
          echo "=== Source files ==="
          ls -la src/ || echo "src/ not found"
          echo ""
          echo "=== Extension config ==="
          cat extension_config.cmake
          echo ""
          echo "=== CMakeLists.txt ==="
          cat CMakeLists.txt

      - name: Build extension with verbose output
        run: |
          echo "Starting build with full output..."
          make debug VERBOSE=1

      - name: Show complete directory tree after build
        run: |
          echo "=== Complete directory tree ==="
          tree build/ || find build/ -type f
          echo ""
          echo "=== All files containing 'extension' ==="
          find . -name "*extension*" -type f
          echo ""
          echo "=== All .duckdb_extension files ==="
          find . -name "*.duckdb_extension" -type f
          echo ""
          echo "=== DuckDB binary location ==="
          find build/ -name "duckdb" -type f

      - name: Test extension if found
        run: |
          EXTENSION_FILE=$(find . -name "*.duckdb_extension" -type f | head -1)
          DUCKDB_BINARY=$(find build/ -name "duckdb" -executable -type f | head -1)
          
          if [ -z "$EXTENSION_FILE" ]; then
            echo "❌ No extension file found"
            exit 1
          fi
          
          if [ -z "$DUCKDB_BINARY" ]; then
            echo "❌ No duckdb binary found"
            exit 1
          fi
          
          echo "Extension file: $EXTENSION_FILE"
          echo "DuckDB binary: $DUCKDB_BINARY"
          
          echo "Testing extension..."
          $DUCKDB_BINARY -c "INSTALL '$EXTENSION_FILE'; LOAD polarsgodmode; SELECT 'Success!' as result;"
