name: Build and Commit Binaries

on:
  push:
    branches: [ master, main, develop, dev ]
    paths:
      - 'src/**'
      - 'CMakeLists.txt'
      - 'extension_config.cmake'
      - 'Makefile'

permissions:
  contents: write

jobs:
  build-binaries:
    name: Build Binaries
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux_amd64
            container: ubuntu:22.04
          - os: macos-latest
            platform: osx_arm64
          - os: macos-13
            platform: osx_amd64
          - os: windows-latest
            platform: windows_amd64

    runs-on: ${{ matrix.os }}
    container: ${{ matrix.container }}

    steps:
      - name: Install packages (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          apt-get update -y -qq
          apt-get install -y -qq cmake ninja-build make gcc g++ git curl zip unzip tar pkg-config

      - name: Install build dependencies (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          choco install -y cmake ninja

      - name: Setup MSVC (Windows)
        if: matrix.os == 'windows-latest'
        uses: microsoft/setup-msbuild@v1.0.2

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Fix Git ownership (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          git config --global --add safe.directory /__w/stps-extension/stps-extension
          git config --global --add safe.directory '*'

      - name: Setup submodules
        shell: ${{ matrix.os == 'windows-latest' && 'bash' || 'sh' }}
        run: |
          # Create .gitmodules if it doesn't exist
          if [ ! -f ".gitmodules" ]; then
            cat > .gitmodules << 'EOF'
          [submodule "duckdb"]
          	path = duckdb
          	url = https://github.com/duckdb/duckdb.git
          [submodule "extension-ci-tools"]
          	path = extension-ci-tools
          	url = https://github.com/duckdb/extension-ci-tools.git
          EOF
          fi
          
          # Initialize and update submodules
          git submodule add https://github.com/duckdb/duckdb.git duckdb || true
          git submodule add https://github.com/duckdb/extension-ci-tools.git extension-ci-tools || true
          git submodule update --init --recursive

      - name: Build extension (Release)
        shell: ${{ matrix.os == 'windows-latest' && 'bash' || 'sh' }}
        run: |
          make release

      - name: Prepare binary artifact
        shell: ${{ matrix.os == 'windows-latest' && 'bash' || 'sh' }}
        run: |
          mkdir -p binary-output/${{ matrix.platform }}
          
          # Find the extension file dynamically
          EXTENSION_FILE=$(find build -name "*.duckdb_extension" -type f | head -1)
          
          if [ -z "$EXTENSION_FILE" ]; then
            echo "âŒ No extension file found"
            exit 1
          fi
          
          echo "Found extension file: $EXTENSION_FILE"
          cp "$EXTENSION_FILE" binary-output/${{ matrix.platform }}/polarsgodmode.duckdb_extension
          
          # Create a README for this platform
          cat > binary-output/${{ matrix.platform }}/README.md << 'EOF'
          # Pre-built Binary for ${{ matrix.platform }}

          This is a pre-built extension binary for the STPS Extension.

          ## Usage

          ```sql
          -- Install the extension
          INSTALL './binaries/${{ matrix.platform }}/polarsgodmode.duckdb_extension';

          -- Load the extension
          LOAD polarsgodmode;

          -- Use extension functions
          SELECT uuid_generate_v4();
          ```

          ## Build Information
          - Platform: ${{ matrix.platform }}
          - Built by: GitHub Actions
          - Repository: ${{ github.repository }}
          - Commit: ${{ github.sha }}
          - Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          EOF

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.platform }}
          path: binary-output/${{ matrix.platform }}/

  commit-binaries:
    name: Commit Binaries to Repository
    needs: build-binaries
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Download all binary artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloaded-binaries

      - name: Organize binaries
        run: |
          # Create binaries directory structure
          mkdir -p binaries
          
          # Move each platform's binaries to the correct location
          for platform_dir in downloaded-binaries/binary-*; do
            if [ -d "$platform_dir" ]; then
              platform_name=$(basename "$platform_dir" | sed 's/^binary-//')
              echo "Processing platform: $platform_name"
              mkdir -p "binaries/$platform_name"
              cp -r "$platform_dir"/* "binaries/$platform_name/"
            fi
          done
          
          # Update main binaries README
          cat > binaries/README.md << 'EOF'
          # Pre-built Binaries

          This directory contains pre-built binaries for the STPS Extension, automatically built by GitHub Actions.

          ## Available Platforms

          - **linux_amd64**: Linux x86_64 systems
          - **osx_arm64**: macOS Apple Silicon (M1/M2/M3)
          - **osx_amd64**: macOS Intel systems
          - **windows_amd64**: Windows x86_64 systems

          ## Quick Start

          After cloning or pulling the repository, you can immediately use the pre-built extension without building:

          ### Linux/macOS Example:
          ```bash
          # Start DuckDB
          duckdb

          # In DuckDB:
          INSTALL './binaries/linux_amd64/polarsgodmode.duckdb_extension';
          LOAD polarsgodmode;
          SELECT uuid_generate_v4();
          ```

          ### Windows Example:
          ```bash
          # Start DuckDB
          duckdb.exe

          # In DuckDB:
          INSTALL './binaries/windows_amd64/polarsgodmode.duckdb_extension';
          LOAD polarsgodmode;
          SELECT uuid_generate_v4();
          ```

          ## Build Information

          These binaries are automatically rebuilt whenever source code changes are pushed to the repository.

          ## Manual Building

          If you prefer to build the extension yourself or need a different platform, see the main [README.md](../README.md) for build instructions.
          EOF

      - name: Commit and push binaries
        run: |
          git add binaries/
          
          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update pre-built binaries [skip ci]"
            git push origin ${{ github.ref_name }}
          fi

