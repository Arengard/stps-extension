# name: test/sql/drop_null_columns.test
# description: Test stps_drop_null_columns table function
# group: [stps]

require stps

# Test 1: Table with some all-NULL columns and some non-NULL columns
statement ok
CREATE TABLE test_mixed AS SELECT
    1 as id,
    'Alice' as name,
    NULL::INTEGER as all_null_int,
    25 as age,
    NULL::VARCHAR as all_null_str,
    'Engineer' as job;

statement ok
INSERT INTO test_mixed VALUES (2, 'Bob', NULL, 30, NULL, 'Doctor');

statement ok
INSERT INTO test_mixed VALUES (3, 'Charlie', NULL, 35, NULL, 'Teacher');

# Should return only id, name, age, job (excluding all_null_int and all_null_str)
query IITI
SELECT * FROM stps_drop_null_columns('test_mixed');
----
1	Alice	25	Engineer
2	Bob	30	Doctor
3	Charlie	35	Teacher

# Test 2: Table with partially NULL columns (should keep all columns)
statement ok
CREATE TABLE test_partial AS SELECT
    1 as id,
    'Alice' as name,
    NULL::INTEGER as sometimes_null,
    25 as age;

statement ok
INSERT INTO test_partial VALUES (2, 'Bob', 42, 30);

statement ok
INSERT INTO test_partial VALUES (3, 'Charlie', NULL, 35);

# Should return all columns since sometimes_null has at least one non-NULL value
query IITI
SELECT * FROM stps_drop_null_columns('test_partial');
----
1	Alice	NULL	25
2	Bob	42	30
3	Charlie	NULL	35

# Test 3: Table with no NULL columns (should return all columns)
statement ok
CREATE TABLE test_no_nulls AS SELECT
    1 as id,
    'Alice' as name,
    25 as age;

statement ok
INSERT INTO test_no_nulls VALUES (2, 'Bob', 30);

query IIT
SELECT * FROM stps_drop_null_columns('test_no_nulls');
----
1	Alice	25
2	Bob	30

# Test 4: Table with all columns NULL
statement ok
CREATE TABLE test_all_null AS SELECT
    NULL::INTEGER as col1,
    NULL::VARCHAR as col2,
    NULL::BIGINT as col3;

statement ok
INSERT INTO test_all_null VALUES (NULL, NULL, NULL);

statement ok
INSERT INTO test_all_null VALUES (NULL, NULL, NULL);

# Should return empty result (no columns or only internal column)
query I
SELECT COUNT(*) FROM stps_drop_null_columns('test_all_null');
----
0

# Test 5: Empty table (should return all columns since we can't determine NULL status)
statement ok
CREATE TABLE test_empty AS SELECT
    1 as id,
    'Alice' as name,
    25 as age
WHERE false;

query I
SELECT COUNT(*) FROM stps_drop_null_columns('test_empty');
----
0

# Test 6: Various data types
statement ok
CREATE TABLE test_types AS SELECT
    1 as int_col,
    'text' as varchar_col,
    NULL::DOUBLE as null_double,
    true as bool_col,
    NULL::DATE as null_date,
    TIMESTAMP '2024-01-01 10:00:00' as timestamp_col;

statement ok
INSERT INTO test_types VALUES (2, 'more text', NULL, false, NULL, TIMESTAMP '2024-01-02 11:00:00');

# Should exclude null_double and null_date
query ITTTT
SELECT * FROM stps_drop_null_columns('test_types');
----
1	text	true	2024-01-01 10:00:00
2	more text	false	2024-01-02 11:00:00

# Cleanup
statement ok
DROP TABLE test_mixed;

statement ok
DROP TABLE test_partial;

statement ok
DROP TABLE test_no_nulls;

statement ok
DROP TABLE test_all_null;

statement ok
DROP TABLE test_empty;

statement ok
DROP TABLE test_types;
