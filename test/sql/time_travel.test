# name: test/sql/time_travel.test
# description: Test time travel functions
# group: [stps]

require stps

# Create a test table with data
statement ok
CREATE TABLE tt_test (id INTEGER, name VARCHAR, email VARCHAR);

statement ok
INSERT INTO tt_test VALUES (1, 'Alice', 'alice@example.com'), (2, 'Bob', 'bob@example.com');

# Enable time travel tracking
statement ok
SELECT stps_tt_enable('tt_test', 'id');

# Verify metadata table was created
query ITII
SELECT table_name, pk_column, current_version, (created_at IS NOT NULL)::INT FROM _stps_tt_tables;
----
tt_test	id	0	1

# Verify history table was created with initial snapshot
query I
SELECT COUNT(*) FROM _stps_history_tt_test;
----
2

# Verify initial snapshot has correct data
query ITIT
SELECT id, name, _tt_version, _tt_operation FROM _stps_history_tt_test ORDER BY id;
----
1	Alice	0	INSERT
2	Bob	0	INSERT

# Test stps_tt_disable
statement ok
CREATE TABLE tt_disable_test (id INTEGER, val VARCHAR);

statement ok
SELECT stps_tt_enable('tt_disable_test', 'id');

statement ok
SELECT stps_tt_disable('tt_disable_test');

# Metadata should be removed
query I
SELECT COUNT(*) FROM _stps_tt_tables WHERE table_name = 'tt_disable_test';
----
0

# History table should be dropped
statement error
SELECT * FROM _stps_history_tt_disable_test;
----

# Error cases: enable on non-existent table
statement error
SELECT stps_tt_enable('nonexistent_table', 'id');
----

# Error cases: enable with non-existent column
statement error
SELECT stps_tt_enable('tt_test', 'nonexistent_col');
----

# Error cases: enable on already tracked table
statement error
SELECT stps_tt_enable('tt_test', 'id');
----

# Error cases: disable on non-tracked table
statement error
SELECT stps_tt_disable('some_random_table');
----

# ============================================================
# Test table functions: stps_time_travel, stps_tt_log,
# stps_tt_status, stps_tt_diff
# Uses manually inserted history records for deterministic tests.
# ============================================================

statement ok
CREATE TABLE tt_travel (id INTEGER, name VARCHAR, score INTEGER);

statement ok
INSERT INTO tt_travel VALUES (1, 'Alice', 150);

statement ok
SELECT stps_tt_enable('tt_travel', 'id');

# Manually populate history to simulate: version 0 = empty,
# version 1 = INSERT Alice 100 + Bob 200, version 2 = UPDATE Alice 150 + Bob 200,
# version 3 = DELETE Bob (Alice 150 remains)

statement ok
DELETE FROM "_stps_history_tt_travel";

statement ok
INSERT INTO "_stps_history_tt_travel" VALUES
    (1, 'Alice', 100, 1, 'SNAPSHOT', '2025-01-01 00:00:00', '1'),
    (2, 'Bob', 200, 1, 'SNAPSHOT', '2025-01-01 00:00:00', '2'),
    (1, 'Alice', 150, 2, 'SNAPSHOT', '2025-01-02 00:00:00', '1'),
    (2, 'Bob', 200, 2, 'SNAPSHOT', '2025-01-02 00:00:00', '2'),
    (1, 'Alice', 150, 3, 'SNAPSHOT', '2025-01-03 00:00:00', '1'),
    (2, 'Bob', 200, 3, 'DELETE', '2025-01-03 00:00:00', '2');

statement ok
UPDATE "_stps_tt_tables" SET current_version = 3 WHERE table_name = 'tt_travel';

# Time travel to version 0 (before any DML)
query I
SELECT COUNT(*) FROM stps_time_travel('tt_travel', version := 0);
----
0

# Time travel to version 1 (after INSERT: Alice 100, Bob 200)
query ITI
SELECT * FROM stps_time_travel('tt_travel', version := 1) ORDER BY id;
----
1	Alice	100
2	Bob	200

# Time travel to version 2 (after UPDATE: Alice 150, Bob 200)
query ITI
SELECT * FROM stps_time_travel('tt_travel', version := 2) ORDER BY id;
----
1	Alice	150
2	Bob	200

# Time travel to version 3 (after DELETE: only Alice 150)
query ITI
SELECT * FROM stps_time_travel('tt_travel', version := 3) ORDER BY id;
----
1	Alice	150

# ============================================================
# Test stps_tt_log
# ============================================================

query I
SELECT COUNT(*) FROM stps_tt_log('tt_travel');
----
6

query I
SELECT COUNT(DISTINCT _tt_version) FROM stps_tt_log('tt_travel');
----
3

# ============================================================
# Test stps_tt_status
# ============================================================

# There are two tracked tables: tt_test and tt_travel
query ITI
SELECT table_name, pk_column, current_version FROM stps_tt_status() WHERE table_name = 'tt_travel';
----
tt_travel	id	3

# ============================================================
# Test stps_tt_diff
# ============================================================

# Diff from version 1 to version 3: Alice changed (UPDATE), Bob removed (DELETE)
query ITI
SELECT id, _tt_change_type, score FROM stps_tt_diff('tt_travel', from_version := 1, to_version := 3) ORDER BY id;
----
1	UPDATE	150
2	DELETE	200

# Cleanup travel test
statement ok
SELECT stps_tt_disable('tt_travel');

statement ok
DROP TABLE tt_travel;

# ============================================================
# Test transparent DML tracking via optimizer extension
# ============================================================

statement ok
CREATE TABLE tt_dml (id INTEGER, name VARCHAR, score INTEGER);

statement ok
SELECT stps_tt_enable('tt_dml', 'id');

# INSERT should be tracked automatically
statement ok
INSERT INTO tt_dml VALUES (1, 'Alice', 100);

# Trigger flush by querying history — the SELECT goes through the optimizer
# which flushes the pending capture from the INSERT above
query I
SELECT COUNT(*) FROM _stps_history_tt_dml WHERE _tt_operation = 'SNAPSHOT' AND _tt_version = 1;
----
1

# UPDATE should be tracked
statement ok
UPDATE tt_dml SET score = 200 WHERE id = 1;

# Trigger flush
query I
SELECT COUNT(*) FROM _stps_history_tt_dml WHERE _tt_version = 2;
----
1

# DELETE should be tracked
statement ok
DELETE FROM tt_dml WHERE id = 1;

# Trigger flush — should have a DELETE marker
query I
SELECT COUNT(*) FROM _stps_history_tt_dml WHERE _tt_operation = 'DELETE' AND _tt_version = 3;
----
1

# Cleanup DML test
statement ok
SELECT stps_tt_disable('tt_dml');

statement ok
DROP TABLE tt_dml;

# ============================================================
# Cleanup from earlier tests
# ============================================================

# Cleanup
statement ok
SELECT stps_tt_disable('tt_test');

statement ok
DROP TABLE tt_test;

statement ok
DROP TABLE tt_disable_test;
