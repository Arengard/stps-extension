# name: test/sql/uuid_functions.test
# description: Test UUID generation functions
# group: [stps]

require stps

# stps_uuid - generates random UUID v4
# We can only verify format, not exact value
query I
SELECT length(stps_uuid()) = 36;
----
true

query I
SELECT stps_uuid() LIKE '________-____-4___-____-____________';
----
true

# stps_uuid_from_string - deterministic UUID v5 from string
# Same input should always produce same output
query T
SELECT stps_uuid_from_string('test');
----
f9e6e6ef-197c-5b25-9f2c-d9c79423ab75

query T
SELECT stps_uuid_from_string('hello');
----
a430d846-80aa-5d0b-b695-136cbd22ce9b

query I
SELECT stps_uuid_from_string('test') = stps_uuid_from_string('test');
----
true

query I
SELECT stps_uuid_from_string('a') != stps_uuid_from_string('b');
----
true

query T
SELECT stps_uuid_from_string('');
----
cbf29ce4-8422-5325-9e37-79b97f4a7c15

# stps_get_guid - deterministic UUID from multiple columns
query T
SELECT stps_get_guid('col1');
----
0bd0b391-1963-54e0-997a-677942646d30

query T
SELECT stps_get_guid('col1', 'col2');
----
c8ee2fd9-e115-5da0-9d26-b6c622bb1bd0

query T
SELECT stps_get_guid('col1', 'col2', 'col3');
----
5ffd981c-560e-5a93-8a98-887a0d439223

# Same inputs should produce same GUID
query I
SELECT stps_get_guid('a', 'b') = stps_get_guid('a', 'b');
----
true

# stps_guid_to_path - convert GUID to 4-level folder path
# f9=249, e6=230, e6=230, ef=239
query T
SELECT stps_guid_to_path('f9e6e6ef-197c-5b25-9f2c-d9c79423ab75');
----
249/230/230/239

# Works without hyphens
query T
SELECT stps_guid_to_path('f9e6e6ef197c5b259f2cd9c79423ab75');
----
249/230/230/239

# Case insensitive - uppercase
query T
SELECT stps_guid_to_path('F9E6E6EF-197C-5B25-9F2C-D9C79423AB75');
----
249/230/230/239

# Different GUID produces different path
# a4=164, 30=48, d8=216, 46=70
query T
SELECT stps_guid_to_path('a430d846-80aa-5d0b-b695-136cbd22ce9b');
----
164/48/216/70

# Deterministic - same GUID always gives same path
query I
SELECT stps_guid_to_path('f9e6e6ef-197c-5b25-9f2c-d9c79423ab75') = stps_guid_to_path('f9e6e6ef-197c-5b25-9f2c-d9c79423ab75');
----
true

# Edge case: 00000000 gives 0/0/0/0
query T
SELECT stps_guid_to_path('00000000-0000-0000-0000-000000000000');
----
0/0/0/0

# Edge case: ffffffff gives 255/255/255/255
query T
SELECT stps_guid_to_path('ffffffff-ffff-ffff-ffff-ffffffffffff');
----
255/255/255/255

# Invalid GUID - too short
query T
SELECT stps_guid_to_path('abc');
----
ERROR: Invalid GUID

# Invalid GUID - invalid characters
query T
SELECT stps_guid_to_path('ghijklmn-opqr-stuv-wxyz-123456789012');
----
ERROR: Invalid GUID

# dguid - deterministic GUID from JSON (works with row_to_json)
# Simple JSON object
query T
SELECT dguid('{"col1": "value1"}');
----
be88fe02-85d3-5af7-9a72-0e7db21bba05

# Multiple values - keys are sorted for determinism
query T
SELECT dguid('{"col1": "value1", "col2": "value2"}');
----
a54cc3db-4cf4-5fbb-ab71-e9ca3d6d9df7

# Order doesn't matter - keys are sorted
query I
SELECT dguid('{"col1": "value1", "col2": "value2"}') = dguid('{"col2": "value2", "col1": "value1"}');
----
true

# Same JSON produces same GUID
query I
SELECT dguid('{"a": "1", "b": "2"}') = dguid('{"a": "1", "b": "2"}');
----
true

# Works with to_json function
query I
SELECT dguid(to_json({'name': 'test', 'id': 123})) = dguid(to_json({'id': 123, 'name': 'test'}));
----
true

# Nested objects are handled
query T
SELECT dguid('{"outer": {"inner": "value"}}');
----
be88fe02-85d3-5af7-9a72-0e7db21bba05

# Arrays are handled with index
query T
SELECT dguid('{"arr": ["a", "b"]}');
----
2d04f3a5-2cb6-5d3d-82b7-09f18cafd9f9

# Null values are skipped (like stps_get_guid)
query I
SELECT dguid('{"a": "1", "b": null}') = dguid('{"a": "1"}');
----
true

# dguid with struct/row - the preferred usage pattern
# Create a test table
statement ok
CREATE TABLE dguid_test (id INTEGER, name VARCHAR, value DOUBLE);

statement ok
INSERT INTO dguid_test VALUES (1, 'alice', 100.5), (2, 'bob', 200.0), (1, 'alice', 100.5);

# dguid(table_alias) generates deterministic GUID from row
query I
SELECT dguid(t) IS NOT NULL FROM dguid_test t LIMIT 1;
----
true

# Same row data produces same GUID
query I
SELECT COUNT(DISTINCT dguid(t)) FROM dguid_test t WHERE id = 1 AND name = 'alice';
----
1

# Different rows produce different GUIDs
query I
SELECT dguid(t) FROM dguid_test t WHERE id = 1 LIMIT 1;
----

query I
SELECT COUNT(DISTINCT dguid(t)) >= 2 FROM dguid_test t;
----
true

# Works with table name directly
query I
SELECT dguid(dguid_test) IS NOT NULL FROM dguid_test LIMIT 1;
----
true

# Struct literal works too
query I
SELECT dguid({'a': 1, 'b': 'test'}) = dguid({'b': 'test', 'a': 1});
----
true

statement ok
DROP TABLE dguid_test;
